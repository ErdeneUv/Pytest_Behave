networks:
  selenium-grid:
    name: selenium-grid
    driver: bridge

services:
  selenium-hub:
    image: selenium/hub:4.27.0
    platform: linux/arm64
    container_name: brandcycle-selenium-hub
    ports:
     - "4442:4442"
     - "4443:4443"
     - "4444:4444"
    environment:
      - GRID_MAX_SESSIONS=3
      - GRID_TIMEOUT=900000
      - SE_LOG_LEVEL=INFO
    healthcheck:
      # Selenium 4 also supports /status; /wd/hub/status remains ok
      test: [ "CMD", "curl", "--fail", "http://localhost:4444/wd/hub/status" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - selenium-grid
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"

  chrome:
    image: selenium/node-chromium:4.27.0
    platform: linux/arm64
    container_name: brandcycle-selenium-node-chrome
    depends_on:
      selenium-hub:
        condition: service_healthy
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - NODE_MAX_SESSIONS=2
      - NODE_MAX_INSTANCES=2
      - SE_NODE_SESSION_TIMEOUT=180
      - SE_LOG_LEVEL=INFO  # Reduces logging
      - JAVA_OPTS=-Xmx512m           # Limits Java heap for node
    volumes:
      - ${BITBUCKET_CLONE_DIR:-.}/shared-downloads:/shared-downloads # volume to store downloaded files
    shm_size: 512m
    healthcheck:
      test: [ "CMD", "curl", "--fail", "http://localhost:5555/status" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - selenium-grid
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"

  test-automation:
    container_name: test-automation
    build: .
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import os; print(os.getcwd()); import behave'; requests.get(\"http://selenium-hub:4444/wd/hub/status\")"]
      interval: 30s
      timeout: 10s
      retries: 3
    environment:
      - PYTHONPATH=/test-automation
      - BEHAVE_DEBUG=False
      - ENVIRONMENT=prod
      - BROWSER=remote_chrome
      - PYTHONUNBUFFERED=1
      - DOWNLOAD_DIR=/shared-downloads
    volumes:
      - ${BITBUCKET_CLONE_DIR:-.}/shared-downloads:/shared-downloads  #same volume that chrome stored downloaded file, it will look up here to find downloaded files
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"
    working_dir: /test-automation
    depends_on:
      selenium-hub:
        condition: service_healthy
    command: tail -f /dev/null
    networks:
      - selenium-grid